<!DOCTYPE html> <!--recognizes file type as HTML-->

<html lang="en"> <!--sets language to english-->

<head>
    <meta charset="UTF-8" /> <!--tells web browser to interpret doc using UTF-8 encoding-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!--allows for mobile compatibility-->
    <title>Admin Dashboard</title> <!--Title shown in browser tab-->
    <script src="https://cdn.tailwindcss.com"></script> <!--loads tailwind for styling-->
</head>

<body class="bg-gray-400 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6">

    <h1 class="text-3xl font-bold text-black mb-4 text-center">RSVP Submissions
    </h1>

    <!--Table for RSVP data-->

    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border">
            <thead>
                <tr>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Name</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Email</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">ID</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Guests</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Time</th>
                </tr>
            </thead>
        <tbody id="tableData" class="text-sm"></tbody>
      </table>
    </div>

    <!--Export Button-->

    <div class="flex justify-center mt-6 space-x-4">
        <button id="exportBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Export CSV
        </button>
    </div>
    
    <!--Clear Entries Button-->

    <button id="clearBtn" type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Clear All Entries
    </button>

    </div>

    <script defer> (() => {
        const STORAGE_KEY = "qrDataList"; // key under which the RSVP list is stored in localStorage

        const tableBody   = document.getElementById("tableData");
        const exportBtn   = document.getElementById("exportBtn");
        const clearBtn    = document.getElementById("clearBtn");

        function loadRSVPs() { // fetches the RSVP array from localStorage, parses it, and populates the table
            tableBody.innerHTML = "";
            let list = [];

            try { // handles empty-state and corrupt data.
                list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } 
            catch {
                console.warn("Corrupt storage; resetting.");
                localStorage.removeItem(STORAGE_KEY);
            }

            if (list.length === 0) { // no entries show a row indicating "No RSVPs yet
                const tr = document.createElement("tr");
                tr.innerHTML = `
                <td colspan="5"
                    class="border px-4 py-2 text-center italic text-gray-500">
                    No RSVPs yet.
                </td>`;

                tableBody.appendChild(tr);
                return;
            }

            list.slice().reverse().forEach(entry => { // reverses list to show latest submissions first
                const tr = document.createElement("tr");

                // Build guest list
                
                const guests = [];
                if (entry.guest1fname) guests.push(`${entry.guest1fname} ${entry.guest1lname}`);
                if (entry.guest2fname) guests.push(`${entry.guest2fname} ${entry.guest2lname}`);

                tr.innerHTML = `
                <td class="border px-4 py-2">${entry.fname} ${entry.lname}</td>
                <td class="border px-4 py-2">${entry.email}</td>
                <td class="border px-4 py-2">${entry.hofstraId}</td>
                <td class="border px-4 py-2">${guests.join("<br>")}</td>
                <td class="border px-4 py-2">${entry.submitTime }
                </td>
                `;

                tableBody.appendChild(tr);
            });
        }

        // Export the full list as CSV

        function exportCSV() { // converts the entire RSVP list into a CSV string
            let list = [];

            try { 
                list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } 
            catch { 
                alert("Cannot export: storage is corrupt.");
                return;
            }

            if (list.length === 0) { 
                alert("No data to export.");
                return;
            }

            const headers = ["Name","Email","ID","Guests","Time"];

            const rows = list.map(e => {
                const guests = [];
                
                if (e.guest1fname) {
                    guests.push(`${e.guest1fname} ${e.guest1lname}`);
                }

                if (e.guest2fname) {
                    guests.push(`${e.guest2fname} ${e.guest2lname}`);
                }

                return [`${e.fname} ${e.lname}`, e.email, e.hofstraId, guests.join(" | "), new Date(e.submitTime)].map(f => `"${f.replace(/"/g,'""')}"`);
            });

            const csv = [headers.map(h=>`"${h}"`), ...rows].map(r=>r.join(",")).join("\r\n");

            const blob = new Blob([csv], { type: "text/csv" }); // creates a Blob
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");

            a.href = url;
            a.download = `rsvp_data-${new Date().toISOString().split("T")[0]}.csv`;

            document.body.appendChild(a);
            a.click(); // trigger download
            document.body.removeChild(a);

            URL.revokeObjectURL(url); // release memory
        }

        function clearEntries() { // clear storage & refresh page
            if (!confirm( // prompts the user for confirmation
                "Are you sure you want to delete ALL RSVP entries? This cannot be undone."
            )) return;

            localStorage.removeItem(STORAGE_KEY); // removes all data from localStorage
            loadRSVPs(); // refresh table
        }

        // wire up event listeners after DOM is ready

        exportBtn.addEventListener("click", exportCSV);
        clearBtn.addEventListener("click", clearEntries);
        window.addEventListener("DOMContentLoaded", loadRSVPs);
    })();
    </script>
</body>
</html>
