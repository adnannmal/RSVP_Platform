<!DOCTYPE html> <!--recognizes file type as HTML-->

<html lang="en"> <!--sets language to english-->

<head>
    <meta charset="UTF-8" /> <!--tells web browser to interpret doc using UTF-8 encoding-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!--allows for mobile compatibility-->
    <title>Admin Dashboard</title> <!--Title shown in browser tab-->
    <link rel="icon" type="image/png" href="Images/logo.png" /> <!-- Tab icon -->
    <script src="https://cdn.tailwindcss.com"></script> <!--loads tailwind for styling-->
</head>

<body class="bg-gray-400 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6">

    <h1 class="text-3xl font-bold text-black mb-4 text-center">RSVP Submissions
    </h1>

    <!--Table for RSVP data-->

    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border">
            <thead>
                <tr>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Name</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Email</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">ID</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Guests</th>
                    <th scope="col" class="border px-4 py-2 bg-blue-300">Time</th>
                </tr>
            </thead>
        <tbody id="tableData" class="text-sm"></tbody>
      </table>
    </div>

    <!--Export Button-->

    <div class="flex justify-center mt-6 space-x-4">
        <button id="exportBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Export CSV
        </button>
    </div>
    
    <!--Clear Entries Button-->

    <button id="clearBtn" type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Clear All Entries
    </button>

    </div>

    <script>
        const API_BASE = "https://rsvp-backend-mb2j.onrender.com";

        const tableBody = document.getElementById("tableData");
        const exportBtn = document.getElementById("exportBtn");
        const clearBtn  = document.getElementById("clearBtn");

        async function loadRSVPs() {
            tableBody.innerHTML = "";
            try {
                const r = await fetch(`${API_BASE}/rsvps`);
                const list = await r.json();

                if (!Array.isArray(list) || list.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="border px-4 py-2 text-center italic text-gray-500">No RSVPs yet.</td></tr>`;
                    return;
                }

                for (const e of list) {
                    const guests = [];
                    
                    if (e.guest1fname || e.guest1lname) {
                        guests.push(`${e.guest1fname || ""} ${e.guest1lname || ""}`.trim());
                    }

                    if (e.guest2fname || e.guest2lname) {
                        guests.push(`${e.guest2fname || ""} ${e.guest2lname || ""}`.trim());
                    }

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="border px-4 py-2">${(e.fname || "")} ${(e.lname || "")}</td>
                        <td class="border px-4 py-2">${e.email || ""}</td>
                        <td class="border px-4 py-2">${e.hofstraId || ""}</td>
                        <td class="border px-4 py-2">${guests.join("<br>")}</td>
                        <td class="border px-4 py-2">${e.submitTime || ""}</td>
                    `;
                    tableBody.appendChild(tr);
                }
            } 
            catch (err) {
                console.error(err);
                alert("Failed to load RSVPs");
            }
        }

        function exportCSV() {
            window.location.href = `${API_BASE}/export.csv`;
        }

        async function clearEntries() {
            if (!confirm("Delete ALL RSVP entries? This cannot be undone.")) {
                return;
            }
            try {
                await fetch(`${API_BASE}/rsvps`, { method: "DELETE" });
                loadRSVPs();
            } 
            catch (err) {
                console.error(err);
                alert("Failed to clear");
            }
        }

        exportBtn?.addEventListener("click", exportCSV);
        clearBtn?.addEventListener("click", clearEntries);
        window.addEventListener("DOMContentLoaded", loadRSVPs);
    </script>

</body>
</html>