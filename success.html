<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thank You</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    emailjs.init("TBfzGP_u0hyoM6TEf"); // public key
  </script>
  
</head>

<body class="bg-green-100 min-h-screen flex flex-col items-center justify-center">
  <!--Thank you message-->
  <div class="text-center p-3 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold text-green-700 mb-2">🎉 Thank You!</h1>
    <p class="text-gray-700">Your RSVP has been submitted successfully.</p>
    <p class="text-gray-700">A email confirmation will  be sent shortly.</p>
  </div>

  <!--QR Code-->
  <div id="qr-container" class="text-center">
    <p class="mb-2 mt-2 text-gray-800">Below is your Ticket 🎟️:</p>
    <p class="mb-2 text-gray-800">(All names listed are on one ticket)</p>
    <canvas id="qr-code" class="mx-auto"></canvas>
    <button type="download" class="bg-green-600 text-white px-4 py-2 mt-4 rounded hover:bg-blue-700 w-full">Dowload Ticket PDF   <!--Dowload button-->
    </button>
  </div>

  
  
  <script>
    // Retrieve  data from local storage
    const qrData = localStorage.getItem("qrData");

    if (!qrData) {
      console.warn("No QR code data found in local storage");
    } 
    else {
      QRCode.toCanvas(document.getElementById("qr-code"), qrData, function (error) { // Generate QR code from the RSVP data
        if (error) {
          console.error("QR generation failed", error);
        } 
        else {
          console.log("QR generated successfully");
          sendTicketEmail(JSON.parse(qrData)); // Send the QR ticket via email
        }
      });

      document.getElementById("downloadBtn").addEventListener("click", function () { // PDF download when button is clicked
        html2pdf().from(document.getElementById("ticket")).save("PSA_Ticket.pdf");
      });
    }

    function sendTicketEmail(data) { // Function to send an email with PDF attached
      html2pdf().from(document.getElementById("ticket")).outputPdf("datauristring").then((pdfDataUri) => { // Generate the PDF and get it as a Data URI
        
        emailjs.send("TBfzGP_u0hyoM6TEf", "template_yczzbhr", { // Send email using EmailJS
          to_email: data.email,             // recipient's email
          from_name: "PSA RSVP",            // sender's name
          message: "Thank you for RSVPing! Your ticket is attached as a PDF.",
          pdf_data: pdfDataUri              // encoded PDF as string
        }).then(
          (response) => console.log("Email sent!", response.status, response.text),
          (error) => console.error("Email failed", error)
        );
      });
    }
  </script>
</body>
</html>